<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="description" content="StopTheCharge Admin Dashboard - Monitor webhooks and submissions">
    <meta name="theme-color" content="#4F46E5">
    <title>Admin Dashboard - StopTheCharge</title>
    <link rel="manifest" href="manifest.json">
    <link rel="stylesheet" href="css/style.css">
    <style>
        .admin-header {
            background: linear-gradient(135deg, #dc2626 0%, #991b1b 100%);
        }
        
        .admin-container {
            padding: 40px 0;
        }
        
        .admin-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 20px;
            margin-bottom: 40px;
        }
        
        .admin-card {
            background: var(--white);
            border: 1px solid var(--border-color);
            border-radius: 12px;
            padding: 20px;
        }
        
        .admin-card h3 {
            margin-top: 0;
            color: var(--primary-color);
        }
        
        .admin-content {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 30px;
        }
        
        .admin-section {
            background: var(--white);
            border: 1px solid var(--border-color);
            border-radius: 12px;
            padding: 30px;
        }
        
        .admin-section h2 {
            margin-top: 0;
            border-bottom: 2px solid var(--border-color);
            padding-bottom: 15px;
        }
        
        .status-indicator {
            display: inline-block;
            width: 12px;
            height: 12px;
            border-radius: 50%;
            margin-right: 8px;
        }
        
        .status-healthy {
            background: #10b981;
        }
        
        .status-warning {
            background: #f59e0b;
        }
        
        .status-error {
            background: #ef4444;
        }
        
        .webhook-row {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 12px 0;
            border-bottom: 1px solid var(--border-color);
        }
        
        .webhook-row:last-child {
            border-bottom: none;
        }
        
        .webhook-name {
            font-weight: 600;
        }
        
        .webhook-status {
            display: flex;
            align-items: center;
            gap: 8px;
        }
        
        .logs-table {
            width: 100%;
            border-collapse: collapse;
        }
        
        .logs-table th {
            background: var(--light-bg);
            padding: 12px;
            text-align: left;
            font-weight: 600;
            border-bottom: 2px solid var(--border-color);
        }
        
        .logs-table td {
            padding: 12px;
            border-bottom: 1px solid var(--border-color);
        }
        
        .logs-table tr:hover {
            background: var(--light-bg);
        }
        
        .log-event {
            display: inline-block;
            padding: 4px 8px;
            border-radius: 4px;
            font-size: 0.85rem;
            font-weight: 600;
        }
        
        .event-request {
            background: rgba(59, 130, 246, 0.1);
            color: #1e40af;
        }
        
        .event-success {
            background: rgba(16, 185, 129, 0.1);
            color: #065f46;
        }
        
        .event-error {
            background: rgba(239, 68, 68, 0.1);
            color: #7f1d1d;
        }
        
        .stat-row {
            display: flex;
            justify-content: space-between;
            padding: 10px 0;
            border-bottom: 1px solid var(--border-color);
        }
        
        .stat-row:last-child {
            border-bottom: none;
        }
        
        .stat-label {
            color: var(--text-light);
        }
        
        .stat-value {
            font-weight: 600;
            color: var(--primary-color);
        }
        
        .button-group {
            display: flex;
            gap: 10px;
            margin-top: 20px;
        }
        
        .admin-warning {
            background: #fef3c7;
            border-left: 4px solid #f59e0b;
            padding: 15px;
            border-radius: 6px;
            margin-bottom: 20px;
        }
        
        .submissions-list {
            max-height: 400px;
            overflow-y: auto;
        }
        
        .submission-item {
            background: var(--light-bg);
            border-left: 4px solid var(--primary-color);
            padding: 12px;
            margin-bottom: 10px;
            border-radius: 4px;
        }
        
        .submission-time {
            font-size: 0.85rem;
            color: var(--text-light);
        }
        
        .submission-service {
            font-weight: 600;
            color: var(--text-dark);
        }
        
        .empty-state-admin {
            text-align: center;
            padding: 40px 20px;
            color: var(--text-light);
        }
        
        @media (max-width: 768px) {
            .admin-content {
                grid-template-columns: 1fr;
            }
            
            .admin-grid {
                grid-template-columns: 1fr;
            }
        }
    </style>
</head>
<body>
    <!-- Navigation -->
    <nav class="navbar">
        <div class="container">
            <div class="navbar-brand">
                <a href="index.html" class="logo-link">üí≥ StopTheCharge</a>
            </div>
            <button class="navbar-toggle" id="navbarToggle" aria-label="Toggle navigation" aria-expanded="false" aria-controls="navbarMenu">
                <span></span>
                <span></span>
                <span></span>
            </button>
            <ul class="navbar-menu" id="navbarMenu">
                <li><a href="index.html" class="nav-link">Home</a></li>
                <li><a href="directory.html" class="nav-link">Directory</a></li>
                <li><a href="dashboard.html" class="nav-link">Dashboard</a></li>
                <li><a href="admin.html" class="nav-link active">Admin</a></li>
            </ul>
        </div>
    </nav>

    <!-- Header -->
    <header class="header admin-header">
        <div class="container">
            <h1>üîß Admin Dashboard</h1>
            <p>Monitor webhooks, submissions, and system status</p>
        </div>
    </header>

    <!-- Admin Warning -->
    <div class="admin-container">
        <div class="container">
            <div class="admin-warning">
                <strong>‚ö†Ô∏è Admin Only:</strong> This dashboard is for monitoring StopTheCharge system status. 
                Ensure this page is protected with authentication in production.
            </div>
        </div>
    </div>

    <!-- Quick Stats -->
    <div class="admin-container">
        <div class="container">
            <div class="admin-grid">
                <div class="admin-card">
                    <h3>Total Submissions</h3>
                    <p style="font-size: 2rem; color: #4f46e5; margin: 0;" id="totalSubmissions">0</p>
                    <p style="color: #6b7280; margin: 5px 0 0 0;">All-time submissions received</p>
                </div>
                <div class="admin-card">
                    <h3>Webhook Status</h3>
                    <div style="display: flex; align-items: center; gap: 10px; font-size: 1.5rem;">
                        <span class="status-indicator" id="webhookStatusIndicator"></span>
                        <span id="webhookStatusText">Checking...</span>
                    </div>
                </div>
                <div class="admin-card">
                    <h3>Recent Logs</h3>
                    <p style="font-size: 2rem; color: #4f46e5; margin: 0;" id="recentLogsCount">0</p>
                    <p style="color: #6b7280; margin: 5px 0 0 0;">Last 24 hours</p>
                </div>
            </div>
        </div>
    </div>

    <!-- Main Content -->
    <div class="admin-container">
        <div class="container">
            <div class="admin-content">
                <!-- Webhook Status -->
                <div class="admin-section">
                    <h2>üîó Webhook Status</h2>
                    <div id="webhookStatus">
                        <p style="text-align: center; color: var(--text-light);">Loading webhook status...</p>
                    </div>
                </div>

                <!-- Recent Submissions -->
                <div class="admin-section">
                    <h2>üì® Recent Submissions</h2>
                    <div class="submissions-list" id="submissionsList">
                        <div class="empty-state-admin">
                            <p>No submissions yet</p>
                        </div>
                    </div>
                </div>

                <!-- Webhook Logs -->
                <div class="admin-section" style="grid-column: 1 / -1;">
                    <h2>üìã Webhook Logs</h2>
                    <div style="display: flex; gap: 10px; margin-bottom: 20px;">
                        <button class="cta-button cta-primary" id="refreshLogsBtn">üîÑ Refresh Logs</button>
                        <button class="cta-button cta-secondary" id="clearLogsBtn">üóëÔ∏è Clear Logs</button>
                        <button class="cta-button cta-secondary" id="exportLogsBtn">üì• Export Logs</button>
                    </div>
                    <div style="overflow-x: auto;">
                        <table class="logs-table" id="logsTable">
                            <thead>
                                <tr>
                                    <th>Timestamp</th>
                                    <th>Event Type</th>
                                    <th>Webhook</th>
                                    <th>Status</th>
                                    <th>Details</th>
                                </tr>
                            </thead>
                            <tbody id="logsTableBody">
                                <tr>
                                    <td colspan="5" style="text-align: center; color: var(--text-light);">
                                        No logs available
                                    </td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                </div>

                <!-- Configuration -->
                <div class="admin-section" style="grid-column: 1 / -1;">
                    <h2>‚öôÔ∏è Configuration</h2>
                    <div style="background: var(--light-bg); padding: 15px; border-radius: 6px; font-family: monospace; font-size: 0.9rem; overflow-x: auto;">
                        <strong>N8N Webhook URLs:</strong>
                        <div id="configDisplay" style="white-space: pre-wrap; margin-top: 10px; color: var(--text-light);">
                            Loading configuration...
                        </div>
                    </div>
                </div>

                <!-- Actions -->
                <div class="admin-section" style="grid-column: 1 / -1;">
                    <h2>üöÄ Actions</h2>
                    <div class="button-group">
                        <button class="cta-button cta-primary" id="testWebhooksBtn">Test All Webhooks</button>
                        <button class="cta-button cta-primary" id="resendFailedBtn">Resend Failed</button>
                        <button class="cta-button cta-secondary" id="sendTestEmailBtn">Send Test Email</button>
                    </div>
                    <div style="margin-top: 20px;" id="actionResult"></div>
                </div>
            </div>
        </div>
    </div>

    <!-- Footer -->
    <footer class="footer">
        <div class="container">
            <p>&copy; 2025 StopTheCharge. All rights reserved. Take control of your subscriptions.</p>
        </div>
    </footer>

    <!-- Scripts -->
    <!-- N8N Configuration -->
    <script src="config/n8n-config.js"></script>
    <script src="backend/config.js"></script>
    <script src="backend/webhook-handlers.js"></script>
    <script src="backend/email-templates.js"></script>
    <script src="js/app.js"></script>
    
    <script>
        // Initialize admin dashboard
        document.addEventListener('DOMContentLoaded', () => {
            console.log('[Admin] Initializing Admin Dashboard...');
            setupNavigation();
            initializeAdminDashboard();
        });

        /**
         * Initialize admin dashboard
         */
        function initializeAdminDashboard() {
            // Load initial data
            loadWebhookStatus();
            loadRecentSubmissions();
            loadWebhookLogs();
            loadConfiguration();
            
            // Setup event listeners
            document.getElementById('refreshLogsBtn')?.addEventListener('click', loadWebhookLogs);
            document.getElementById('clearLogsBtn')?.addEventListener('click', clearWebhookLogs);
            document.getElementById('exportLogsBtn')?.addEventListener('click', exportWebhookLogs);
            document.getElementById('testWebhooksBtn')?.addEventListener('click', testAllWebhooks);
            document.getElementById('resendFailedBtn')?.addEventListener('click', resendFailedWebhooks);
            document.getElementById('sendTestEmailBtn')?.addEventListener('click', sendTestEmail);
            
            // Auto-refresh every 30 seconds
            setInterval(() => {
                loadWebhookLogs();
                loadRecentSubmissions();
            }, 30000);
            
            console.log('[Admin] Admin Dashboard initialized');
        }

        /**
         * Load and display webhook status
         */
        async function loadWebhookStatus() {
            const statusDiv = document.getElementById('webhookStatus');
            const indicator = document.getElementById('webhookStatusIndicator');
            const statusText = document.getElementById('webhookStatusText');
            
            try {
                if (typeof window.WebhookHandlers !== 'undefined') {
                    const statuses = await window.WebhookHandlers.getAllWebhookStatus();
                    
                    let healthyCount = 0;
                    let html = '';
                    
                    statuses.forEach(webhook => {
                        const isHealthy = webhook.healthy || webhook.status === 200;
                        if (isHealthy) healthyCount++;
                        
                        const statusClass = isHealthy ? 'status-healthy' : 'status-error';
                        const statusLabel = isHealthy ? 'Healthy' : 'Error';
                        
                        html += `
                            <div class="webhook-row">
                                <div class="webhook-name">${webhook.name}</div>
                                <div class="webhook-status">
                                    <span class="status-indicator ${statusClass}"></span>
                                    <span>${statusLabel}</span>
                                </div>
                            </div>
                        `;
                    });
                    
                    statusDiv.innerHTML = html;
                    
                    // Update overall status
                    const allHealthy = healthyCount === statuses.length;
                    indicator.className = `status-indicator ${allHealthy ? 'status-healthy' : 'status-warning'}`;
                    statusText.textContent = allHealthy ? 'All Healthy' : `${healthyCount}/${statuses.length} Healthy`;
                } else {
                    statusDiv.innerHTML = '<p style="color: var(--text-light);">‚ö†Ô∏è WebhookHandlers not loaded</p>';
                    indicator.className = 'status-indicator status-error';
                    statusText.textContent = 'Not Available';
                }
            } catch (error) {
                console.error('[Admin] Error loading webhook status:', error);
                statusDiv.innerHTML = `<p style="color: var(--text-light);">Error: ${error.message}</p>`;
                indicator.className = 'status-indicator status-error';
                statusText.textContent = 'Error';
            }
        }

        /**
         * Load recent submissions
         */
        function loadRecentSubmissions() {
            const list = document.getElementById('submissionsList');
            const subscriptions = getSubscriptionsFromStorage();
            
            if (subscriptions.length === 0) {
                list.innerHTML = '<div class="empty-state-admin"><p>No submissions yet</p></div>';
                document.getElementById('totalSubmissions').textContent = '0';
                return;
            }
            
            document.getElementById('totalSubmissions').textContent = subscriptions.length;
            
            // Show last 5 submissions
            const recent = subscriptions.slice(-5).reverse();
            
            list.innerHTML = recent.map(sub => `
                <div class="submission-item">
                    <div class="submission-service">${sub.serviceName}</div>
                    <div style="margin-top: 5px; font-size: 0.9rem; color: var(--text-light);">
                        ${sub.category} ‚Ä¢ $${sub.cost}/mo ‚Ä¢ Renewal: ${sub.renewalDate}
                    </div>
                    <div class="submission-time">Added: ${sub.dateSaved}</div>
                </div>
            `).join('');
        }

        /**
         * Load webhook logs
         */
        function loadWebhookLogs() {
            const tbody = document.getElementById('logsTableBody');
            
            let logs = [];
            if (typeof window.WebhookHandlers !== 'undefined' && window.WebhookHandlers.webhookLogger) {
                logs = window.WebhookHandlers.webhookLogger.getLogs().reverse().slice(0, 50);
            }
            
            document.getElementById('recentLogsCount').textContent = logs.filter(log => {
                const logDate = new Date(log.timestamp);
                const dayAgo = new Date(Date.now() - 24 * 60 * 60 * 1000);
                return logDate > dayAgo;
            }).length;
            
            if (logs.length === 0) {
                tbody.innerHTML = '<tr><td colspan="5" style="text-align: center; color: var(--text-light);">No logs available</td></tr>';
                return;
            }
            
            tbody.innerHTML = logs.map(log => {
                const eventClass = log.event.includes('error') ? 'event-error' : 
                                 log.event.includes('success') ? 'event-success' : 'event-request';
                const webhook = log.data?.action || 'Unknown';
                const details = JSON.stringify(log.data || {}).substring(0, 50);
                
                return `
                    <tr>
                        <td style="font-size: 0.85rem;">${new Date(log.timestamp).toLocaleString()}</td>
                        <td><span class="log-event ${eventClass}">${log.event}</span></td>
                        <td>${webhook}</td>
                        <td>${log.event.includes('success') ? '‚úÖ' : log.event.includes('error') ? '‚ùå' : 'üì§'}</td>
                        <td style="font-size: 0.85rem; color: var(--text-light);">${details}...</td>
                    </tr>
                `;
            }).join('');
        }

        /**
         * Clear webhook logs
         */
        function clearWebhookLogs() {
            if (confirm('Clear all webhook logs? This cannot be undone.')) {
                if (typeof window.WebhookHandlers !== 'undefined' && window.WebhookHandlers.webhookLogger) {
                    window.WebhookHandlers.webhookLogger.clearLogs();
                    loadWebhookLogs();
                    alert('Logs cleared successfully');
                }
            }
        }

        /**
         * Export webhook logs
         */
        function exportWebhookLogs() {
            let logs = [];
            if (typeof window.WebhookHandlers !== 'undefined' && window.WebhookHandlers.webhookLogger) {
                logs = window.WebhookHandlers.webhookLogger.getLogs();
            }
            
            const csv = 'Timestamp,Event,Action,Details\n' +
                logs.map(log => 
                    `"${log.timestamp}","${log.event}","${log.data?.action || 'N/A'}","${JSON.stringify(log.data || '')}"`
                ).join('\n');
            
            const blob = new Blob([csv], { type: 'text/csv' });
            const url = window.URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `webhook-logs-${getCurrentDate()}.csv`;
            a.click();
            window.URL.revokeObjectURL(url);
        }

        /**
         * Load and display configuration
         */
        function loadConfiguration() {
            const display = document.getElementById('configDisplay');
            
            if (typeof window.StopTheChargeConfig !== 'undefined') {
                const config = window.StopTheChargeConfig;
                const webhooks = config.N8N_WEBHOOKS || {};
                
                let configText = '';
                Object.entries(webhooks).forEach(([name, url]) => {
                    configText += `${name}: ${url || 'NOT SET'}\n`;
                });
                
                display.textContent = configText || 'No configuration available';
            } else {
                display.textContent = 'Configuration not loaded';
            }
        }

        /**
         * Test all webhooks
         */
        async function testAllWebhooks() {
            const result = document.getElementById('actionResult');
            result.innerHTML = '<p style="color: var(--text-light);">Testing webhooks...</p>';
            
            try {
                const statuses = await window.WebhookHandlers.getAllWebhookStatus();
                const healthy = statuses.filter(s => s.healthy).length;
                result.innerHTML = `‚úÖ Test complete: ${healthy}/${statuses.length} webhooks healthy`;
            } catch (error) {
                result.innerHTML = `‚ùå Error: ${error.message}`;
            }
        }

        /**
         * Resend failed webhooks
         */
        async function resendFailedWebhooks() {
            const result = document.getElementById('actionResult');
            result.innerHTML = '<p style="color: var(--text-light);">Fetching failed webhooks...</p>';
            
            let logs = [];
            if (typeof window.WebhookHandlers !== 'undefined' && window.WebhookHandlers.webhookLogger) {
                logs = window.WebhookHandlers.webhookLogger.getLogsByEvent('webhook_error');
            }
            
            result.innerHTML = `Found ${logs.length} failed webhook(s). Resend functionality would be implemented in production.`;
        }

        /**
         * Send test email
         */
        async function sendTestEmail() {
            const result = document.getElementById('actionResult');
            const email = prompt('Enter test email address:');
            
            if (!email) return;
            
            result.innerHTML = '<p style="color: var(--text-light);">Sending test email...</p>';
            
            try {
                const response = await window.WebhookHandlers.sendWelcomeEmailWebhook(email, 'Test User');
                if (response.success) {
                    result.innerHTML = '‚úÖ Test email sent successfully';
                } else {
                    result.innerHTML = `‚ùå Error: ${response.error}`;
                }
            } catch (error) {
                result.innerHTML = `‚ùå Error: ${error.message}`;
            }
        }

        /**
         * Get current date
         */
        function getCurrentDate() {
            return new Date().toISOString().split('T')[0];
        }
    </script>
</body>
</html>
